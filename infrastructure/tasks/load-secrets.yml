---
# Load secrets from local-secrets.yml, prompting on first run if the file doesn't exist.
# Pass --extra-vars "reconfigure=true" to re-prompt with existing values as defaults.
# Secrets file is gitignored and lives at infrastructure/local-secrets.yml.

- name: Check if local-secrets.yml exists
  stat:
    path: "{{ playbook_dir }}/../local-secrets.yml"
  register: secrets_file
  delegate_to: localhost
  become: no

- name: Set whether prompting is needed
  set_fact:
    should_prompt: "{{ not secrets_file.stat.exists or (reconfigure | default(false) | bool) }}"

- name: Load existing secrets for defaults
  include_vars:
    file: "{{ playbook_dir }}/../local-secrets.yml"
  when: secrets_file.stat.exists and should_prompt

- name: Prompt for database password
  pause:
    prompt: "PostgreSQL password for the '{{ database_user }}' database user [{{ database_password | default('zbbs_dev') }}]"
  register: prompt_database_password
  when: should_prompt
  delegate_to: localhost
  become: no

- name: Prompt for authentication key passphrase (Symfony Login JWT)
  pause:
    prompt: "Passphrase to encrypt the Symfony login JWT authentication key [{{ jwt_key_passphrase | default('zbbs2026') }}]"
  register: prompt_jwt_key_passphrase
  when: should_prompt
  delegate_to: localhost
  become: no

- name: Prompt for real-time messaging secret (Mercure JWT)
  pause:
    prompt: "Shared secret for the Mercure real-time messaging server [{{ mercure_jwt_secret | default('zbbs_jwt_secret') }}]"
  register: prompt_mercure_jwt_secret
  when: should_prompt
  delegate_to: localhost
  become: no

- name: Write local-secrets.yml
  copy:
    content: |
      # ZBBS local secrets (auto-generated, gitignored)
      # Delete this file and re-run the playbook to be prompted again.
      database_password: "{{ prompt_database_password.user_input | default(database_password | default('zbbs_dev'), true) }}"
      jwt_key_passphrase: "{{ prompt_jwt_key_passphrase.user_input | default(jwt_key_passphrase | default('zbbs2026'), true) }}"
      mercure_jwt_secret: "{{ prompt_mercure_jwt_secret.user_input | default(mercure_jwt_secret | default('zbbs_jwt_secret'), true) }}"
    dest: "{{ playbook_dir }}/../local-secrets.yml"
    mode: '0600'
  when: should_prompt
  delegate_to: localhost
  become: no

- name: Load local secrets
  include_vars:
    file: "{{ playbook_dir }}/../local-secrets.yml"
