---
- name: Deploy ZBBS application
  hosts: all
  become: yes
  vars_files:
    - ../group_vars/all.yml

  pre_tasks:
    - name: Load secrets
      include_tasks: ../tasks/load-secrets.yml
      when: deploy_environment == 'development'

  tasks:
    - name: Display deployment info
      debug:
        msg: "Deploying to {{ deploy_environment }} environment"

    - name: Pull latest code from release branch
      git:
        repo: "{{ git_repository }}"
        dest: "{{ project_root }}"
        version: "{{ deploy_branch | default('release') }}"
        force: yes
      when: deploy_environment == 'production'
      become_user: "{{ app_user }}"

    - name: Set up application environment variables
      template:
        src: ../templates/zbbs-env.sh.j2
        dest: /etc/profile.d/zbbs.sh
        mode: '0644'

    - name: Remove .env.local if it exists
      file:
        path: "{{ project_root }}/api/.env.local"
        state: absent

    - name: Install Composer dependencies (this may take a few minutes)
      shell: |
        . /etc/profile.d/zbbs.sh && composer install --no-interaction {{ '--no-dev --optimize-autoloader' if deploy_environment == 'production' else '' }} 2>&1
      args:
        chdir: "{{ project_root }}/api"
      become_user: "{{ app_user }}"
      register: composer_output

    - name: Composer output
      shell: |
        echo "{{ composer_output.stdout }}"
      changed_when: false

    - name: Check if JWT private key exists
      stat:
        path: "{{ project_root }}/api/config/jwt/private.pem"
      register: jwt_private_key

    - name: Verify JWT key matches current passphrase
      command: >
        openssl pkey -in {{ project_root }}/api/config/jwt/private.pem
        -passin pass:{{ jwt_key_passphrase }} -noout
      register: jwt_key_check
      failed_when: false
      changed_when: false
      when: jwt_private_key.stat.exists
      become_user: "{{ app_user }}"
      no_log: true

    - name: Remove JWT keys if passphrase has changed
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ project_root }}/api/config/jwt/private.pem"
        - "{{ project_root }}/api/config/jwt/public.pem"
      when: jwt_private_key.stat.exists and jwt_key_check.rc != 0

    - name: Generate JWT keypair
      command: >
        openssl genpkey -out {{ project_root }}/api/config/jwt/private.pem
        -aes256 -algorithm rsa -pkeyopt rsa_keygen_bits:4096
        -pass pass:{{ jwt_key_passphrase }}
      args:
        creates: "{{ project_root }}/api/config/jwt/private.pem"
      become_user: "{{ app_user }}"

    - name: Extract JWT public key
      command: >
        openssl pkey -in {{ project_root }}/api/config/jwt/private.pem
        -out {{ project_root }}/api/config/jwt/public.pem
        -pubout -passin pass:{{ jwt_key_passphrase }}
      args:
        creates: "{{ project_root }}/api/config/jwt/public.pem"
      become_user: "{{ app_user }}"

    - name: Verify JWT key works with current passphrase
      command: >
        openssl pkey -in {{ project_root }}/api/config/jwt/private.pem
        -passin pass:{{ jwt_key_passphrase }} -noout
      changed_when: false
      become_user: "{{ app_user }}"
      no_log: true

    - name: Ensure JWT key directory permissions
      file:
        path: "{{ project_root }}/api/config/jwt"
        state: directory
        owner: "{{ app_user }}"
        mode: '0700'

    - name: Find all SQL migrations
      find:
        paths: "{{ project_root }}/migrations"
        patterns: "*_up.sql"
      register: migration_files

    - name: Check which migrations have been applied
      shell: |
        sudo -u postgres psql -d {{ database_name }} -t -A -c "SELECT migration_id FROM migrations_applied;"
      register: applied_migrations
      changed_when: false

    - name: Set applied migrations list
      set_fact:
        applied_list: "{{ applied_migrations.stdout_lines | default([]) }}"

    - name: Determine pending migrations
      set_fact:
        pending_migrations: "{{ migration_files.files | sort(attribute='path') | rejectattr('path', 'search', '(' + (applied_list | map('regex_escape') | join('|')) + ')') | list if applied_list | length > 0 else migration_files.files | sort(attribute='path') }}"

    - name: Display migration status
      shell: |
        echo ""
        echo "  Migrations: {{ migration_files.files | length }} total, {{ applied_list | length }} applied, {{ pending_migrations | length }} pending"
        {% for m in pending_migrations %}
        echo "    - {{ m.path | basename }}"
        {% endfor %}
        echo ""
      changed_when: false

    - name: Run pending SQL migrations
      shell: |
        sudo -u postgres psql -d {{ database_name }} -f "{{ item.path }}" && \
        sudo -u postgres psql -d {{ database_name }} -c "INSERT INTO migrations_applied (migration_id) VALUES ('{{ item.path | basename | replace('_up.sql', '') }}');"
      loop: "{{ pending_migrations }}"
      loop_control:
        label: "{{ item.path | basename }}"
      when: run_migrations | default(false) | bool

    - name: Clear Symfony cache (this may take a few minutes)
      shell: |
        . /etc/profile.d/zbbs.sh && php bin/console cache:clear
      args:
        chdir: "{{ project_root }}/api"
      become_user: "{{ app_user }}"

    - name: Install npm dependencies
      npm:
        path: "{{ project_root }}/clients/modern"
        state: present
      become_user: "{{ app_user }}"

    - name: Build Angular for production
      command: ng build --configuration=production
      args:
        chdir: "{{ project_root }}/clients/modern"
      when: deploy_environment == 'production'
      become_user: "{{ app_user }}"

    - name: Restart PHP-FPM
      service:
        name: "php{{ php_version }}-fpm"
        state: restarted

    - name: Reload nginx
      service:
        name: nginx
        state: reloaded

    - name: Display deployment complete message
      shell: |
        echo ""
        echo "==================================="
        echo "  Deploy complete!"
        echo "==================================="
        echo ""
        echo "  Environment: {{ deploy_environment }}"
        echo "  Branch:      {{ deploy_branch | default('release') }}"
        echo ""
      changed_when: false
