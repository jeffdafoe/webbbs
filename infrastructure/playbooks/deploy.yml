---
- name: Deploy WebBBS application
  hosts: all
  become: yes

  tasks:
    - name: Display deployment info
      debug:
        msg: "Deploying to {{ deploy_environment }} environment"

    - name: Pull latest code from release branch
      git:
        repo: "{{ git_repository }}"
        dest: "{{ project_root }}"
        version: "{{ deploy_branch | default('release') }}"
        force: yes
      when: deploy_environment == 'production'
      become_user: "{{ app_user }}"

    - name: Install Composer dependencies
      composer:
        command: install
        working_dir: "{{ project_root }}/api"
        no_dev: "{{ 'yes' if deploy_environment == 'production' else 'no' }}"
        optimize_autoloader: "{{ 'yes' if deploy_environment == 'production' else 'no' }}"
      become_user: "{{ app_user }}"

    - name: Run database migrations
      command: php bin/console doctrine:migrations:migrate --no-interaction
      args:
        chdir: "{{ project_root }}/api"
      become_user: "{{ app_user }}"

    - name: Clear Symfony cache
      command: php bin/console cache:clear
      args:
        chdir: "{{ project_root }}/api"
      become_user: "{{ app_user }}"

    - name: Install npm dependencies
      npm:
        path: "{{ project_root }}/frontend"
        state: present
      become_user: "{{ app_user }}"

    - name: Build Angular for production
      command: ng build --configuration=production
      args:
        chdir: "{{ project_root }}/frontend"
      when: deploy_environment == 'production'
      become_user: "{{ app_user }}"

    - name: Restart PHP-FPM
      service:
        name: "php{{ php_version }}-fpm"
        state: restarted

    - name: Reload nginx
      service:
        name: nginx
        state: reloaded

    - name: Display deployment complete message
      debug:
        msg: |
          Deployment complete!

          Environment: {{ deploy_environment }}
          Branch: {{ deploy_branch | default('release') }}

          Services restarted:
          - PHP-FPM
          - nginx
