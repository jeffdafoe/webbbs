---
- name: Set up ZBBS development/production deploy_environment
  hosts: all
  become: yes
  vars_files:
    - ../group_vars/all.yml

  pre_tasks:
    - name: Display deploy_environment
      debug:
        msg: "Setting up {{ deploy_environment }} deploy_environment on {{ inventory_hostname }}"

  roles:
    - role: ../roles/common
    - role: ../roles/php
    - role: ../roles/postgresql
    - role: ../roles/nodejs
    - role: ../roles/mercure
    - role: ../roles/apache

  post_tasks:
    - name: Check hosts file for development entry
      shell: grep -q "{{ server_name }}" /mnt/c/Windows/System32/drivers/etc/hosts
      register: hosts_check
      changed_when: false
      failed_when: false
      when: deploy_environment == 'development'

    - name: Remind to add hosts file entry
      debug:
        msg: |
          MANUAL STEP REQUIRED: Add this line to C:\Windows\System32\drivers\etc\hosts
          (requires running notepad as Administrator):

          127.0.0.1 {{ server_name }}
      when: deploy_environment == 'development' and hosts_check.rc != 0

    - name: Display setup complete message
      debug:
        msg: |
          Setup complete!

          Environment: {{ deploy_environment }}
          Project root: {{ project_root }}
          {% if deploy_environment == 'development' %}
          Site: http://{{ server_name }}
          {% endif %}

          PHP version: {{ php_version }}
          PostgreSQL version: {{ postgresql_version }}
          Node.js version: {{ nodejs_version }}

          Database: {{ database_name }}
          Database user: {{ database_user }}

          Next steps:
          {% if deploy_environment == 'development' %}
          1. Add SSH key to GitHub (shown above)
          2. Clone repository: git clone {{ git_repository }} {{ project_root }}
          3. Run deploy.yml to install dependencies and build
          {% else %}
          1. Run deploy.yml to pull code and build
          {% endif %}
