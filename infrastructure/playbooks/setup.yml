---
- name: Set up ZBBS development/production deploy_environment
  hosts: all
  become: yes
  vars_files:
    - ../group_vars/all.yml

  pre_tasks:
    - name: Load secrets
      include_tasks: ../tasks/load-secrets.yml
      when: deploy_environment == 'development'

    - name: Display deploy_environment
      debug:
        msg: "Setting up {{ deploy_environment }} deploy_environment on {{ inventory_hostname }}"

  roles:
    - role: ../roles/common
    - role: ../roles/php
    - role: ../roles/postgresql
    - role: ../roles/nodejs
    - role: ../roles/mercure
    - role: ../roles/nginx

  post_tasks:
    - name: Check hosts file for development entry
      shell: grep -q "{{ server_name }}" /mnt/c/Windows/System32/drivers/etc/hosts
      register: hosts_check
      changed_when: false
      failed_when: false
      when: deploy_environment == 'development'

    - name: Remind to add hosts file entry
      shell: |
        echo ""
        echo "  NOTE: Add this line to C:\Windows\System32\drivers\etc\hosts"
        echo "  (requires running notepad as Administrator):"
        echo ""
        echo "  127.0.0.1 {{ server_name }}"
        echo ""
      when: deploy_environment == 'development' and hosts_check.rc != 0
      changed_when: false

    - name: Display setup complete message
      shell: |
        echo ""
        echo "==================================="
        echo "  Setup complete!"
        echo "==================================="
        echo ""
        echo "  Environment:  {{ deploy_environment }}"
        echo "  Project root: {{ project_root }}"
        {% if deploy_environment == 'development' %}
        echo "  Site:         http://{{ server_name }}"
        {% endif %}
        echo ""
        echo "  PHP:          {{ php_version }}"
        echo "  PostgreSQL:   {{ postgresql_version }}"
        echo "  Node.js:      {{ nodejs_version }}"
        echo ""
        echo "  Database:     {{ database_name }}"
        echo "  DB user:      {{ database_user }}"
        echo ""
        echo "  Next step:"
        echo "  Run deploy.yml to install dependencies and build"
        echo ""
      changed_when: false
